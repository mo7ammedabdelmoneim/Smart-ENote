{% extends "pronunciation/index.html" %}

{% block title %}AI Text Generator - Smart E-Note{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto px-3 sm:px-0">
    <!-- Page Header -->
    <div class="bg-white rounded-lg border border-gray-200 px-4 sm:px-6 py-4 mb-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-6 h-6 text-purple-600">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
                </svg>
            </div>
            <div>
                <h1 class="text-lg sm:text-xl font-bold text-gray-800">AI Text Generator</h1>
                <p class="text-xs text-gray-500">Generate text and practice pronunciation with AI</p>
            </div>
        </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6">

        <!-- Topic Input -->
        <div class="mb-4">
            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-4 h-4 text-gray-500 flex-shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                </svg>
                Topic (Optional)
            </label>
            <input id="topicInput" placeholder="e.g. Technology, Travel, Health..."
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
        </div>

        <!-- Level Select -->
        <div class="mb-5">
            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-4 h-4 text-gray-500 flex-shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                </svg>
                Language Level
            </label>
            <select id="levelSelect"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <option value="A1">A1 - Beginner</option>
                <option value="A2">A2 - Elementary</option>
                <option value="B1" selected>B1 - Intermediate</option>
                <option value="B2">B2 - Upper Intermediate</option>
                <option value="C1">C1 - Advanced</option>
                <option value="C2">C2 - Proficient</option>
            </select>
        </div>

        <!-- Generate Button -->
        <button id="generateBtn"
            class="bg-purple-600 text-white px-5 py-2.5 text-sm rounded-lg font-medium w-full hover:bg-purple-700 flex items-center justify-center gap-2 mb-5">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
            </svg>
            Generate AI Text
        </button>

        <!-- Divider -->
        <div class="border-t border-gray-200 mb-5"></div>

        <!-- Generated Text -->
        <div class="mb-5 hidden" id="textSection">
            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-4 h-4 text-gray-500 flex-shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                Generated Text
            </label>
            <textarea id="originalText" rows="5"
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg bg-purple-50 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                readonly></textarea>
        </div>

        <!-- Recording Section -->
        <div id="recordSection" class="hidden">

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 mb-5">
                <button id="recordBtn"
                    class="w-full sm:w-auto bg-purple-600 text-white px-5 py-2.5 text-sm rounded-lg font-medium hover:bg-purple-700 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                    </svg>
                    <span>Start Recording</span>
                </button>

                <button id="submitBtn" disabled
                    class="w-full sm:w-auto bg-gray-400 text-white px-5 py-2.5 text-sm rounded-lg font-medium flex items-center justify-center gap-2 cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                    </svg>
                    <span>Submit</span>
                </button>
            </div>

            <!-- Spoken Text -->
            <div class="mb-5">
                <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-4 h-4 text-gray-500 flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                    </svg>
                    Your Speech
                </label>
                <div id="spokenText"
                    class="min-h-[120px] sm:min-h-[150px] bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm leading-relaxed">
                    <p class="text-gray-400 text-center py-6 sm:py-8">Your recorded speech will appear here...</p>
                </div>
            </div>

            <!-- Result Section -->
            <div id="resultDiv" class="hidden">
                <div
                    class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4 sm:p-5">
                    <div class="flex items-center gap-2 mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                            stroke="currentColor" class="w-5 h-5 text-purple-600 flex-shrink-0">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h4 class="font-semibold text-gray-800">Results</h4>
                    </div>

                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-600">Score:</span>
                            <span id="scoreSpan" class="text-lg font-bold text-purple-600">-</span>
                        </div>

                        <div>
                            <span class="text-sm font-medium text-gray-600 block mb-1">Feedback:</span>
                            <p id="feedbackSpan" class="text-sm text-gray-700">-</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

</div>

<!-- Processing Overlay -->
<div id="overlay" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-2xl text-center w-[90%] max-w-sm mx-4">
        <!-- Animated Spinner -->
        <div class="relative w-16 h-16 mx-auto mb-4">
            <div class="absolute inset-0 border-4 border-purple-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-purple-600 border-t-transparent rounded-full animate-spin">
            </div>
        </div>

        <h3 class="text-lg font-semibold text-gray-800 mb-2">Processing</h3>
        <p class="text-sm text-gray-600">Please wait...</p>

        <!-- Progress Animation -->
        <div class="flex items-center justify-center gap-1 mt-4">
            <div class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
            <div class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
            <div class="w-2 h-2 bg-purple-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
        </div>
    </div>
</div>

<style>
    .blurred-word {
        display: inline-block;
        margin-right: 4px;
        filter: blur(6px);
        opacity: 0.45;
    }

    .interim-word {
        color: #9ca3af;
        font-style: italic;
    }

    .wrong-word {
        color: #dc2626;
        font-weight: 600;
        background-color: #fee2e2;
        padding: 2px 4px;
        border-radius: 4px;
    }
</style>

<script>
    let recognition;
    let isRecording = false;
    let finalTranscript = "";

    const topicInput = document.getElementById("topicInput");
    const levelSelect = document.getElementById("levelSelect");
    const generateBtn = document.getElementById("generateBtn");

    const textSection = document.getElementById("textSection");
    const originalText = document.getElementById("originalText");
    const recordSection = document.getElementById("recordSection");

    const recordBtn = document.getElementById("recordBtn");
    const submitBtn = document.getElementById("submitBtn");
    const spokenTextDiv = document.getElementById("spokenText");

    const resultDiv = document.getElementById("resultDiv");
    const scoreSpan = document.getElementById("scoreSpan");
    const feedbackSpan = document.getElementById("feedbackSpan");

    const overlay = document.getElementById("overlay");

    /* UTILS */
    function showOverlay() {
        overlay.classList.remove("hidden");
        overlay.classList.add("flex");
    }

    function hideOverlay() {
        overlay.classList.add("hidden");
        overlay.classList.remove("flex");
    }

    /* GENERATE AI TEXT */
    generateBtn.addEventListener("click", async () => {
        showOverlay();

        const res = await fetch("/pronunciation/ai-text", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                topic: topicInput.value,
                level: levelSelect.value
            })
        });

        const data = await res.json();

        originalText.value = data.generated_text || "";
        textSection.classList.remove("hidden");
        recordSection.classList.remove("hidden");

        spokenTextDiv.innerHTML = '<p class="text-gray-400 text-center py-8">Your recorded speech will appear here...</p>';
        resultDiv.classList.add("hidden");

        hideOverlay();
    });

    /* SPEECH RECOGNITION */
    function initRecognition() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();

        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "en-US";

        recognition.onresult = e => {
            let interimText = "";

            for (let i = e.resultIndex; i < e.results.length; i++) {
                const transcript = e.results[i][0].transcript.trim();

                if (e.results[i].isFinal) {
                    finalTranscript += " " + transcript;
                    renderFinal(transcript);
                } else {
                    interimText += transcript + " ";
                }
            }

            renderInterim(interimText);
        };
    }

    function renderFinal(text) {
        removeInterim();

        text.split(" ").forEach(word => {
            const span = document.createElement("span");
            span.className = "blurred-word";
            span.textContent = word + " ";
            spokenTextDiv.appendChild(span);
        });
    }

    function renderInterim(text) {
        removeInterim();
        if (!text.trim()) return;

        const span = document.createElement("span");
        span.className = "interim-word";
        span.id = "interim";
        span.textContent = text;
        spokenTextDiv.appendChild(span);
    }

    function removeInterim() {
        const old = document.getElementById("interim");
        if (old) old.remove();
    }

    recordBtn.addEventListener("click", () => {
        if (!recognition) initRecognition();

        if (!isRecording) {
            finalTranscript = "";
            spokenTextDiv.innerHTML = "";
            recognition.start();
            isRecording = true;

            recordBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
                <span>Stop Recording</span>
            `;
            recordBtn.classList.replace("bg-purple-600", "bg-red-600");
            recordBtn.classList.replace("hover:bg-purple-700", "hover:bg-red-700");
            submitBtn.disabled = true;
        } else {
            recognition.stop();
            isRecording = false;
            removeInterim();

            recordBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                </svg>
                <span>Start Recording</span>
            `;
            recordBtn.classList.replace("bg-red-600", "bg-purple-600");
            recordBtn.classList.replace("hover:bg-red-700", "hover:bg-purple-700");

            if (finalTranscript.trim()) {
                submitBtn.disabled = false;
                submitBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
                submitBtn.classList.add("bg-purple-600", "hover:bg-purple-700", "cursor-pointer");
            }
        }
    });

    /* SUBMIT */
    submitBtn.addEventListener("click", async () => {
        showOverlay();

        const res = await fetch("/pronunciation/compare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                original_text: originalText.value,
                spoken_text: finalTranscript
            })
        });

        const data = await res.json();

        spokenTextDiv.innerHTML = data.highlighted_text || finalTranscript;
        scoreSpan.textContent = data.score || "-";
        feedbackSpan.textContent = data.feedback || "-";
        resultDiv.classList.remove("hidden");

        hideOverlay();
    });
</script>


{% endblock %}