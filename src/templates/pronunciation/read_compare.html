{% extends "pronunciation/index.html" %}

{% block title %}Read & Compare - Smart E-Note{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto px-3 sm:px-0">
    <!-- Page Header -->
    <div class="bg-white rounded-lg border border-gray-200 px-4 sm:px-6 py-4 mb-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-6 h-6 text-blue-600">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6.042A8.967 8.967 0 006 3.75c-1.036 0-2.04.186-3 .534V18a10.5 10.5 0 013-.534c2.032 0 3.98.6 5.75 1.63m.25-13.054A8.967 8.967 0 0118 3.75c1.036 0 2.04.186 3 .534V18a10.5 10.5 0 00-3-.534c-2.032 0-3.98.6-5.75 1.63m0-13.054v13.054" />
                </svg>
            </div>
            <div>
                <h1 class="text-lg sm:text-xl font-bold text-gray-800">Read & Compare</h1>
                <p class="text-xs text-gray-500">Practice reading aloud and compare with your speech</p>
            </div>
        </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 sm:p-6">

        <!-- Original Text Section -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-4 h-4 text-gray-500 flex-shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
                Original Text
            </label>
            <textarea id="originalText"
                class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                rows="5" placeholder="Type or paste the text you want to practice reading..."></textarea>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 mb-6">
            <button id="recordBtn" onclick="toggleRecording()"
                class="w-full sm:w-auto bg-blue-600 text-white px-5 py-2.5 text-sm rounded-lg font-medium hover:bg-blue-700 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                </svg>
                <span>Start Recording</span>
            </button>

            <button type="button" id="submitBtn" onclick="submitSpeech()" disabled
                class="w-full sm:w-auto bg-gray-400 text-white px-5 py-2.5 text-sm rounded-lg font-medium flex items-center justify-center gap-2 cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5 flex-shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
                <span>Submit</span>
            </button>
        </div>

        <!-- Divider -->
        <div class="border-t border-gray-200 mb-6"></div>

        <!-- Spoken Text Section -->
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-4 h-4 text-gray-500 flex-shrink-0">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                </svg>
                Your Speech
            </label>
            <div id="spokenText"
                class="min-h-[120px] sm:min-h-[150px] bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm leading-relaxed">
                <p class="text-gray-400 text-center py-6 sm:py-8">Your recorded speech will appear here...</p>
            </div>
        </div>

        <!-- Result Section -->
        <div id="resultDiv" class="mt-6 hidden">
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 sm:p-5">
                <div class="flex items-center gap-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 text-blue-600 flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h4 class="font-semibold text-gray-800">Results</h4>
                </div>

                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-600">Score:</span>
                        <span id="scoreSpan" class="text-lg font-bold text-blue-600">-</span>
                    </div>

                    <div>
                        <span class="text-sm font-medium text-gray-600 block mb-1">Feedback:</span>
                        <p id="feedbackSpan" class="text-sm text-gray-700">-</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Info Box -->
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
            </svg>
            <div>
                <p class="text-sm font-medium text-blue-800 mb-1">How to use:</p>
                <ul class="text-xs text-blue-700 space-y-1">
                    <li>1. Enter or paste the text you want to practice</li>
                    <li>2. Click "Start Recording" and read the text aloud</li>
                    <li>3. Click "Stop Recording" when finished</li>
                    <li>4. Click "Submit" to compare your speech with the original text</li>
                </ul>
            </div>
        </div>
    </div>

</div>

<!-- Processing Overlay -->
<div id="overlay" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white p-6 sm:p-8 rounded-lg shadow-2xl text-center w-[90%] max-w-sm mx-4">
        <!-- Animated Spinner -->
        <div class="relative w-16 h-16 mx-auto mb-4">
            <div class="absolute inset-0 border-4 border-blue-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        </div>

        <h3 class="text-lg font-semibold text-gray-800 mb-2">Processing Speech</h3>
        <p class="text-sm text-gray-600">Analyzing your pronunciation...</p>

        <!-- Progress Animation -->
        <div class="flex items-center justify-center gap-1 mt-4">
            <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
            <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
            <div class="w-2 h-2 bg-blue-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
        </div>
    </div>
</div>

<style>
    .blurred-word {
        display: inline-block;
        margin-right: 4px;
        filter: blur(5px);
        opacity: 0.45;
        transition: filter 0.3s ease;
    }

    .interim-word {
        color: #9ca3af;
        font-style: italic;
        margin-right: 2px;
    }
</style>
<script>
    let recognition;
    let isRecording = false;
    let finalTranscript = "";

    const recordBtn = document.getElementById("recordBtn");
    const submitBtn = document.getElementById("submitBtn");
    const spokenTextDiv = document.getElementById("spokenText");
    const overlay = document.getElementById("overlay");
    const originalText = document.getElementById("originalText");

    const resultDiv = document.getElementById("resultDiv");
    const scoreSpan = document.getElementById("scoreSpan");
    const feedbackSpan = document.getElementById("feedbackSpan");

    /* =====================
       Speech Recognition
    ===================== */
    function initRecognition() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();

        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "en-US";

        recognition.onresult = e => {
            let interimText = "";

            for (let i = e.resultIndex; i < e.results.length; i++) {
                const transcript = e.results[i][0].transcript.trim();

                if (e.results[i].isFinal) {
                    finalTranscript += " " + transcript;
                    renderFinal(transcript);
                } else {
                    interimText += transcript + " ";
                }
            }

            renderInterim(interimText);
        };
    }

    /* =====================
       Render Functions
    ===================== */
    function renderFinal(text) {
        removeInterim();

        text.split(" ").forEach(word => {
            const span = document.createElement("span");
            span.className = "blurred-word";
            span.textContent = word + " ";
            spokenTextDiv.appendChild(span);
        });
    }

    function renderInterim(text) {
        removeInterim();
        if (!text.trim()) return;

        const span = document.createElement("span");
        span.className = "interim-word";
        span.id = "interim";
        span.textContent = text;
        spokenTextDiv.appendChild(span);
    }

    function removeInterim() {
        const old = document.getElementById("interim");
        if (old) old.remove();
    }

    /* =====================
       Toggle Recording
    ===================== */
    recordBtn.addEventListener("click", () => {
        if (!recognition) initRecognition();

        if (!isRecording) {
            // START
            finalTranscript = "";
            spokenTextDiv.innerHTML = "";
            recognition.start();
            isRecording = true;

            recordBtn.innerHTML = `<span>Stop Recording</span>`;
            recordBtn.classList.replace("bg-blue-600", "bg-red-600");
            submitBtn.disabled = true;

            submitBtn.disabled = true;
            submitBtn.classList.replace("bg-blue-600", "bg-gray-400");
            submitBtn.classList.replace("hover:bg-blue-700", "cursor-pointer", "cursor-not-allowed");

        } else {
            // STOP
            recognition.stop();
            isRecording = false;
            removeInterim();

            recordBtn.innerHTML = `<span>Start Recording</span>`;
            recordBtn.classList.replace("bg-red-600", "bg-blue-600");

            if (finalTranscript.trim()) {
                submitBtn.disabled = false;
                submitBtn.classList.replace("bg-gray-400", "bg-blue-600");
                submitBtn.classList.replace("cursor-not-allowed", "cursor-pointer");
            }
        }
    });

    /* =====================
       Submit Speech
    ===================== */
    submitBtn.addEventListener("click", async () => {
        overlay.classList.remove("hidden");
        overlay.classList.add("flex");

        const res = await fetch("/pronunciation/compare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                original_text: originalText.value,
                spoken_text: finalTranscript
            })
        });

        const data = await res.json();

        spokenTextDiv.innerHTML = data.highlighted_text || finalTranscript;
        scoreSpan.textContent = data.score || "-";
        feedbackSpan.textContent = data.feedback || "-";
        resultDiv.classList.remove("hidden");

        overlay.classList.add("hidden");
        overlay.classList.remove("flex");
    });
</script>
{% endblock %}