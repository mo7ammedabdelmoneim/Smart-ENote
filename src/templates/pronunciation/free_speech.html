{% extends "pronunciation/index.html" %}

{% block title %}Free Speech - Smart E-Note{% endblock %}

{% block content %}

<div class="max-w-4xl mx-auto">

    <!-- Page Header -->
    <div class="bg-white rounded-lg border border-gray-200 px-6 py-4 mb-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-red-50 rounded-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-6 h-6 text-red-600">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold text-gray-800">Free Speech Practice</h1>
                <p class="text-xs text-gray-500">Speak freely and get AI feedback on your speech</p>
            </div>
        </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">

        <!-- Record Button -->
        <div class="flex justify-center mb-6">
            <button id="recordBtn" onclick="toggleRecording()"
                class="bg-red-600 text-white px-8 py-3 text-sm rounded-lg font-medium hover:bg-red-700 flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                </svg>
                <span>Start Speaking</span>
            </button>
        </div>

        <!-- Speech Display -->
        <div class="mb-6">
            <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-4 h-4 text-gray-500">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                </svg>
                Your Speech
            </label>
            <div id="spokenText"
                class="min-h-[180px] bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm leading-relaxed text-gray-800">
                <p class="text-gray-400 text-center py-12">Click "Start Speaking" and begin talking...</p>
            </div>
        </div>

        <!-- Analyze Button -->
        <button id="analyzeBtn" onclick="analyzeSpeech()" disabled
            class="bg-gray-400 text-white px-6 py-2.5 text-sm rounded-lg font-medium w-full flex items-center justify-center gap-2 cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
            </svg>
            <span>Analyze Speech</span>
        </button>

        <!-- Result Section -->
        <div id="resultDiv" class="hidden mt-6">

            <!-- Scores Card -->
            <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-lg p-5 mb-4">
                <div class="flex items-center gap-2 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 text-red-600">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                    </svg>
                    <h4 class="font-semibold text-gray-800">Speech Analysis</h4>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-white rounded-lg p-3 border border-red-100">
                        <div class="flex items-center gap-2 mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-gray-500">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                            </svg>
                            <span class="text-xs font-medium text-gray-600">Fluency</span>
                        </div>
                        <p id="fluency" class="text-sm font-semibold text-gray-800">-</p>
                    </div>

                    <div class="bg-white rounded-lg p-3 border border-red-100">
                        <div class="flex items-center gap-2 mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-gray-500">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                            <span class="text-xs font-medium text-gray-600">Pronunciation</span>
                        </div>
                        <p id="pronunciation" class="text-sm font-semibold text-gray-800">-</p>
                    </div>

                    <div class="bg-white rounded-lg p-3 border border-red-100">
                        <div class="flex items-center gap-2 mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-gray-500">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M12 6.042A8.967 8.967 0 006 3.75c-1.036 0-2.04.186-3 .534V18a10.5 10.5 0 013-.534c2.032 0 3.98.6 5.75 1.63m.25-13.054A8.967 8.967 0 0118 3.75c1.036 0 2.04.186 3 .534V18a10.5 10.5 0 00-3-.534c-2.032 0-3.98.6-5.75 1.63m0-13.054v13.054" />
                            </svg>
                            <span class="text-xs font-medium text-gray-600">Grammar</span>
                        </div>
                        <p id="grammar" class="text-sm font-semibold text-gray-800">-</p>
                    </div>

                    <div class="bg-white rounded-lg p-3 border border-red-100">
                        <div class="flex items-center gap-2 mb-1">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-gray-500">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-3.375c0-.621-.503-1.125-1.125-1.125h-.871M7.5 18.75v-3.375c0-.621.504-1.125 1.125-1.125h.872m5.007 0H9.497m5.007 0a7.454 7.454 0 01-.982-3.172M9.497 14.25a7.454 7.454 0 00.981-3.172M5.25 4.236c-.982.143-1.954.317-2.916.52A6.003 6.003 0 007.73 9.728M5.25 4.236V4.5c0 2.108.966 3.99 2.48 5.228M5.25 4.236V2.721C7.456 2.41 9.71 2.25 12 2.25c2.291 0 4.545.16 6.75.47v1.516M7.73 9.728a6.726 6.726 0 002.748 1.35m8.272-6.842V4.5c0 2.108-.966 3.99-2.48 5.228m2.48-5.492a46.32 46.32 0 012.916.52 6.003 6.003 0 01-5.395 4.972m0 0a6.726 6.726 0 01-2.749 1.35m0 0a6.772 6.772 0 01-3.044 0" />
                            </svg>
                            <span class="text-xs font-medium text-gray-600">CEFR Level</span>
                        </div>
                        <p id="level" class="text-sm font-semibold text-red-600">-</p>
                    </div>
                </div>
            </div>

            <!-- Improved Text -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-center gap-2 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 text-green-600">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h4 class="font-semibold text-gray-800 text-sm">Improved Version</h4>
                </div>
                <p id="improvedText" class="text-sm text-gray-700 leading-relaxed">-</p>
            </div>

            <!-- Feedback -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center gap-2 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 text-blue-600">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                    <h4 class="font-semibold text-gray-800 text-sm">Feedback & Tips</h4>
                </div>
                <p id="feedback" class="text-sm text-gray-700 leading-relaxed">-</p>
            </div>

        </div>

    </div>

</div>

<!-- Processing Overlay -->
<div id="overlay" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm mx-4">
        <!-- Animated Spinner -->
        <div class="relative w-16 h-16 mx-auto mb-4">
            <div class="absolute inset-0 border-4 border-red-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-red-600 border-t-transparent rounded-full animate-spin"></div>
        </div>

        <h3 class="text-lg font-semibold text-gray-800 mb-2">Analyzing Speech</h3>
        <p class="text-sm text-gray-600">Evaluating your fluency and pronunciation...</p>

        <!-- Progress Animation -->
        <div class="flex items-center justify-center gap-1 mt-4">
            <div class="w-2 h-2 bg-red-600 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
            <div class="w-2 h-2 bg-red-600 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
            <div class="w-2 h-2 bg-red-600 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
        </div>
    </div>
</div>

<script>
    let recognition;
    let isRecording = false;

    let finalTranscript = "";
    let interimTranscript = "";

    const recordBtn = document.getElementById("recordBtn");
    const analyzeBtn = document.getElementById("analyzeBtn");
    const spokenTextDiv = document.getElementById("spokenText");
    const overlay = document.getElementById("overlay");

    const resultDiv = document.getElementById("resultDiv");
    const fluency = document.getElementById("fluency");
    const pronunciation = document.getElementById("pronunciation");
    const grammar = document.getElementById("grammar");
    const level = document.getElementById("level");
    const improvedText = document.getElementById("improvedText");
    const feedback = document.getElementById("feedback");

    function showOverlay() {
        overlay.classList.remove("hidden");
        overlay.classList.add("flex");
    }
    function hideOverlay() {
        overlay.classList.add("hidden");
        overlay.classList.remove("flex");
    }

    /* =====================
       Speech Recognition
    ===================== */
    function initRecognition() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SR();

        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = "en-US";

        recognition.onresult = e => {
            interimTranscript = "";

            for (let i = e.resultIndex; i < e.results.length; i++) {
                const transcript = e.results[i][0].transcript;

                if (e.results[i].isFinal) {
                    finalTranscript += transcript + " ";
                } else {
                    interimTranscript += transcript;
                }
            }

            spokenTextDiv.innerHTML =
                `<span>${finalTranscript}</span>
                 <span class="text-gray-400 italic">${interimTranscript}</span>`;
        };
    }

    function toggleRecording() {
        if (!recognition) initRecognition();

        if (!isRecording) {
            finalTranscript = "";
            interimTranscript = "";
            spokenTextDiv.innerHTML = "";

            recognition.start();
            isRecording = true;

            recordBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                </svg>
                <span>Stop Speaking</span>
            `;
            recordBtn.classList.replace("bg-red-600", "bg-gray-600");
            recordBtn.classList.replace("hover:bg-red-700", "hover:bg-gray-700");
            analyzeBtn.disabled = true;
        } else {
            recognition.stop();
            isRecording = false;

            recordBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z" />
                </svg>
                <span>Start Speaking</span>
            `;
            recordBtn.classList.replace("bg-gray-600", "bg-red-600");
            recordBtn.classList.replace("hover:bg-gray-700", "hover:bg-red-700");

            if (finalTranscript.trim()) {
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
                analyzeBtn.classList.add("bg-blue-600", "hover:bg-blue-700", "cursor-pointer");
            }
        }
    }

    /* =====================
       Analyze Speech
    ===================== */
    function analyzeSpeech() {
        showOverlay();

        fetch("/pronunciation/free-speech", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: finalTranscript.trim() })
        })
            .then(res => res.json())
            .then(data => {
                fluency.textContent = data.fluency || "-";
                pronunciation.textContent = data.pronunciation || "-";
                grammar.textContent = data.grammar || "-";
                level.textContent = data.level || "-";
                improvedText.textContent = data.improved_text || "-";
                feedback.textContent = data.feedback || "-";

                resultDiv.classList.remove("hidden");
            })
            .catch(err => {
                console.error(err);
                alert("Something went wrong! Please try again.");
            })
            .finally(hideOverlay);
    }
</script>

{% endblock %}