<!-- Header -->
<div class="bg-white rounded-lg border border-gray-200 px-6 py-3 mb-2 flex items-center justify-between">

    <!-- Left side (title + description) -->
    <div>
        <h1 class="text-2xl font-bold text-gray-800">
            {{ selected_topic.title }}
        </h1>
        <p class="text-sm text-gray-500 mt-0.5">
            General learning content
        </p>
    </div>

    <!-- Right side (Quick Quiz button) -->
    <form id="quickQuizForm" method="POST" action="/quiz/quick_quiz">
        <input type="hidden" name="content" id="quizContent">

        <button type="button" onclick="submitQuickQuiz()"
            class="px-4 py-2 text-sm bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 flex items-center gap-2">

            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9 12h6m-6 4h6m2 4H7a2 2 0 01-2-2V6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v12a2 2 0 01-2 2z" />
            </svg>

            Quick Quiz
        </button>
    </form>
</div>

<style>
    .scrollable {
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .scrollable::-webkit-scrollbar {
        display: none;
    }
</style>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Words Section -->
    <section class="bg-white rounded-lg border border-gray-200 p-5 flex flex-col">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 text-indigo-600">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M12 6.042A8.967 8.967 0 006 3.75c-1.036 0-2.04.186-3 .534V18a10.5 10.5 0 013-.534c2.032 0 3.98.6 5.75 1.63m.25-13.054A8.967 8.967 0 0118 3.75c1.036 0 2.04.186 3 .534V18a10.5 10.5 0 00-3-.534c-2.032 0-3.98.6-5.75 1.63m0-13.054v13.054" />
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-gray-800">Vocabulary</h2>
            </div>
            <button onclick="openAddModal('word')"
                class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                + Add Word
            </button>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="text-white text-lg flex flex-col items-center">
                <svg class="animate-spin h-10 w-10 mb-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                    </circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                Loading Quiz...
            </div>
        </div>

        <!-- Words List -->
        <div class="flex-1 space-y-3 scrollable max-h-[370px]">
            {% if words_list %}
            {% for word in words_list %}
            <div class="word-card bg-indigo-50 rounded-lg p-3 hover:shadow-sm border border-indigo-100">
                <div class="flex justify-between items-start gap-3">
                    <p class="topic-word text-sm font-semibold text-indigo-700 flex-1">
                        {{ word }}
                    </p>

                    <div class="flex gap-1 flex-shrink-0">
                        <!-- Speak Button -->
                        <button onclick="handleSpeak(this)" class="p-1.5 hover:bg-indigo-100 rounded-lg" title="Listen">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-indigo-600">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                        </button>

                        <!-- Translate Button -->
                        <button onclick="handleTranslate(this)" class="p-1.5 hover:bg-indigo-100 rounded-lg"
                            title="Translate">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-indigo-600">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" />
                            </svg>
                        </button>
                    </div>
                </div>
                <p class="translation hidden mt-2 text-xs text-gray-700 bg-white rounded-lg p-2 border border-gray-200">
                </p>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-12 h-12 mx-auto text-gray-300 mb-2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 6.042A8.967 8.967 0 006 3.75c-1.036 0-2.04.186-3 .534V18a10.5 10.5 0 013-.534c2.032 0 3.98.6 5.75 1.63m.25-13.054A8.967 8.967 0 0118 3.75c1.036 0 2.04.186 3 .534V18a10.5 10.5 0 00-3-.534c-2.032 0-3.98.6-5.75 1.63m0-13.054v13.054" />
                </svg>
                <p class="text-gray-400 text-sm">No words yet</p>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- Sentences Section -->
    <section class="bg-white rounded-lg border border-gray-200 p-5 flex flex-col">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-green-50 rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                        stroke="currentColor" class="w-5 h-5 text-green-600">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                    </svg>
                </div>
                <h2 class="text-lg font-semibold text-gray-800">Expressions</h2>
            </div>
            <button onclick="openAddModal('sentence')"
                class="px-3 py-1.5 text-sm bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                + Add Sentence
            </button>
        </div>

        <!-- Sentences List -->
        <div class="flex-1 space-y-3 scrollable max-h-[320px]">
            {% if sentences_list %}
            {% for exp in sentences_list %}
            <div class="word-card bg-gray-50 rounded-lg p-3 hover:shadow-sm border border-gray-200">
                <div class="flex justify-between items-start gap-3">
                    <p class="sentence-text text-sm text-gray-800 flex-1">
                        {{ exp }}
                    </p>

                    <div class="flex gap-1 flex-shrink-0">
                        <!-- Speak Button -->
                        <button onclick="handleSpeak(this)" class="p-1.5 hover:bg-gray-200 rounded-lg" title="Listen">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-gray-600">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                            </svg>
                        </button>

                        <!-- Translate Button -->
                        <button onclick="handleTranslate(this)" class="p-1.5 hover:bg-gray-200 rounded-lg"
                            title="Translate">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-4 h-4 text-gray-600">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" />
                            </svg>
                        </button>
                    </div>
                </div>
                <p class="translation hidden mt-2 text-xs text-gray-700 bg-white rounded-lg p-2 border border-gray-200">
                </p>
            </div>
            {% endfor %}
            {% else %}
            <div class="text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-12 h-12 mx-auto text-gray-300 mb-2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                </svg>
                <p class="text-gray-400 text-sm">No sentences yet</p>
            </div>
            {% endif %}
        </div>
    </section>

</div>

<!-- Add Word/Sentence Modal -->
<div id="addModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">

    <div class="bg-white rounded-lg w-full max-w-md mx-4 shadow-xl">

        <!-- Modal Header -->
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 id="modalTitle" class="text-lg font-semibold text-gray-800"></h2>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Content
            </label>
            <textarea id="modalInput" placeholder="Enter text here..."
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                rows="4"></textarea>
        </div>

        <!-- Modal Footer -->
        <div class="px-6 py-4 bg-gray-50 rounded-b-lg flex justify-end gap-2">
            <button onclick="closeModal()"
                class="px-4 py-2 text-sm rounded-lg border border-gray-300 font-medium text-gray-700 hover:bg-gray-100">
                Cancel
            </button>
            <button onclick="saveModal()"
                class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">
                Save
            </button>
        </div>

    </div>
</div>

<script>
    let currentType = "";

    function openAddModal(type) {
        currentType = type;
        document.getElementById("modalTitle").innerText = type === "word" ? "Add New Word" : "Add New Sentence";
        document.getElementById("modalInput").value = "";
        document.getElementById("addModal").classList.remove("hidden");
        document.getElementById("addModal").classList.add("flex");
    }

    function closeModal() {
        document.getElementById("addModal").classList.add("hidden");
        document.getElementById("addModal").classList.remove("flex");
    }

    async function saveModal() {
        const text = document.getElementById("modalInput").value.trim();
        if (!text) {
            alert("Please enter some text");
            return;
        }

        try {
            await fetch(`/general/topic/{{ selected_topic.id }}/add-${currentType}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });
            location.reload();
        } catch (error) {
            alert("Error saving. Please try again.");
        }
    }

    function handleSpeak(button) {
        const card = button.closest(".word-card");
        const textElement = card.querySelector("p:first-child");
        const text = window.getSelection().toString().trim() || textElement.innerText.trim();

        if (!text) return;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "en-US";
        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
    }

    async function handleTranslate(button) {
        const card = button.closest(".word-card");
        const translationEl = card.querySelector(".translation");
        const textElement = card.querySelector("p:first-child");
        const selectedText = window.getSelection().toString().trim() || textElement.innerText.trim();

        if (!selectedText) return;

        // Toggle if same text
        if (!translationEl.classList.contains("hidden") && translationEl.dataset.lastText === selectedText) {
            translationEl.classList.add("hidden");
            return;
        }

        translationEl.textContent = "Translating...";
        translationEl.classList.remove("hidden");
        translationEl.dataset.lastText = selectedText;

        try {
            const response = await fetch("/translate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: selectedText })
            });
            const data = await response.json();
            translationEl.textContent = data.translation || "Translation not available";
        } catch (error) {
            translationEl.textContent = "Translation failed. Please try again.";
        }
    }

    function submitQuickQuiz() {
        const overlay = document.getElementById("quizLoadingOverlay");
        const btn = document.getElementById("quickQuizBtn");

        overlay.classList.remove("hidden");
        overlay.classList.add("flex");
        btn.disabled = true;
        btn.classList.add("opacity-60", "cursor-not-allowed");
        document.getElementById("quickQuizForm").submit();
    }


    function submitQuickQuiz() {

        const vocab = [...document.querySelectorAll(".word-card .topic-word")]
            .map(el => el.innerText.trim());

        const expressions = [...document.querySelectorAll(".word-card .sentence-text")]
            .map(el => el.innerText.trim());

        let content = "";

        if (vocab.length) {
            content += "Vocabulary:\n";
            vocab.forEach(w => content += "- " + w + "\n");
        }

        if (expressions.length) {
            content += "\nExpressions:\n";
            expressions.forEach(e => content += "- " + e + "\n");
        }

        if (!content.trim()) {
            alert("No content to generate quiz");
            return;
        }

        document.getElementById("quizContent").value = content;
        document.getElementById("loadingOverlay").classList.remove("hidden");
        document.getElementById("quickQuizForm").submit();
    }

    // Close modal when clicking outside
    document.getElementById("addModal").addEventListener("click", function (e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Close modal with ESC key
    document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
            closeModal();
        }
    });
</script>