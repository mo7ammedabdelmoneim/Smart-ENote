{% extends "base.html" %}

{% block title %}Assistant - Smart E-Note{% endblock title %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* Custom scrollbar */
    #chatMessages::-webkit-scrollbar {
        width: 6px;
    }

    #chatMessages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #chatMessages::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    #chatMessages::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Typing dots animation */
    .typing-dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        margin: 0 2px;
        background-color: #6b7280;
        /* gray-500 */
        border-radius: 50%;
        animation: bounce 1.0s infinite alternate;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes bounce {
        0% {
            transform: translateY(0);
            opacity: 0.5;
        }

        50% {
            transform: translateY(-6px);
            opacity: 1;
        }

        100% {
            transform: translateY(0);
            opacity: 0.5;
        }
    }
</style>
{% endblock head %}

{% block content %}

<div class="flex flex-col h-[calc(100vh-85px)] sm:h-[calc(100vh-100px)]">

    <!-- ================= CHAT HEADER ================= -->
    <header class="bg-white border border-gray-200 rounded-t-lg px-4 sm:px-6 py-3 sm:py-4">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 sm:w-10 sm:h-10 bg-green-50 rounded-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-5 h-5 sm:w-6 sm:h-6 text-green-600">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
            </div>
            <div>
                <h1 class="text-lg sm:text-xl font-bold text-gray-800">
                    Language Assistant
                </h1>
                <p class="text-xs text-gray-500">
                    Ask me anything about English
                </p>
            </div>
        </div>
    </header>

    <!-- ================= MESSAGES ================= -->
    <main id="chatMessages"
        class="flex-1 bg-gray-50 border-x border-gray-200 px-3 sm:px-6 py-4 overflow-y-auto space-y-3">

        <!-- Welcome -->
        <div id="welcomeMessage" class="bg-white border border-gray-200 rounded-lg p-4 text-center max-w-md mx-auto">
            <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                    stroke="currentColor" class="w-6 h-6 text-green-600">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z" />
                </svg>
            </div>
            <h3 class="font-semibold text-gray-800 mb-1">Hi there ðŸ‘‹</h3>
            <p class="text-sm text-gray-600">
                I'm your English learning assistant.
            </p>
        </div>

    </main>

    <!-- ================= INPUT ================= -->
    <footer class="bg-white border border-gray-200 rounded-b-lg px-3 sm:px-4 py-3">
        <div class="relative max-w-4xl mx-auto">

            <textarea id="chatInput" rows="1" placeholder="Type your question..." class="w-full border border-gray-300 rounded-lg px-4 py-3 pr-12
                       resize-none overflow-hidden
                       focus:outline-none focus:ring-2 focus:ring-green-500
                       text-sm leading-relaxed" style="min-height:44px; max-height:140px;"></textarea>

            <button id="sendBtn" onclick="sendMessage()" class="absolute bottom-2 right-2 h-9 w-9
                       flex items-center justify-center
                       bg-green-600 text-white rounded-lg
                       hover:bg-green-700 transition
                       disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5"
                    stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M6 12L3.269 3.126A59.77 59.77 0 0121.485 12 59.77 59.77 0 013.27 20.876L6 12zm0 0h7.5" />
                </svg>
            </button>

        </div>
    </footer>

</div>

<script>
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    function appendMessage(text, sender) {
        const container = chatMessages;

        // Hide welcome message if first user message
        const welcome = document.getElementById("welcomeMessage");
        if (welcome && sender === "user") welcome.remove();

        const wrapper = document.createElement("div");
        wrapper.className = sender === "user" ? "flex justify-end" : "flex justify-start";

        const msg = document.createElement("div");
        msg.className = sender === "user"
            ? "bg-green-600 text-white px-4 py-2.5 rounded-lg max-w-[85%] sm:max-w-[70%] text-sm break-words"
            : "bg-white border border-gray-200 text-gray-800 px-4 py-2.5 rounded-lg max-w-[85%] sm:max-w-[70%] text-sm break-words";

        if (sender === "bot") {
            msg.innerHTML = marked.parse(text);
            msg.querySelectorAll("p").forEach(p => p.classList.add("mb-2", "last:mb-0"));
            msg.querySelectorAll("code").forEach(c =>
                c.classList.add("bg-gray-100", "px-1", "rounded", "text-xs")
            );
            msg.querySelectorAll("pre").forEach(pre =>
                pre.classList.add("bg-gray-100", "p-3", "rounded-lg", "overflow-x-auto", "my-2")
            );
        } else {
            msg.textContent = text;
        }

        wrapper.appendChild(msg);
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;

        sendBtn.disabled = true;
        appendMessage(text, "user");
        chatInput.value = "";
        chatInput.style.height = "auto";

        showTyping();

        try {
            const res = await fetch("/assistant", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ message: text })
            });
            const data = await res.json();
            removeTyping();
            appendMessage(data.reply, "bot");
        } catch {
            removeTyping();
            appendMessage("Connection error, please try again.", "bot");
        } finally {
            sendBtn.disabled = false;
        }
    }

    function showTyping() {
        const t = document.createElement("div");
        t.id = "typing";
        t.className = "flex justify-start";
        t.innerHTML = `
        <div class="bg-white border px-4 py-2.5 rounded-lg text-sm text-gray-500 flex items-center gap-2">
            Thinking
            <span class="typing-dots">
                <span></span><span></span><span></span>
            </span>
        </div>`;
        chatMessages.appendChild(t);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTyping() {
        document.getElementById("typing")?.remove();
    }

    chatInput.addEventListener("input", () => {
        chatInput.style.height = "auto";
        chatInput.style.height = Math.min(chatInput.scrollHeight, 140) + "px";
    });

    chatInput.addEventListener("keydown", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    chatInput.focus();
</script>

{% endblock content %}